<div class="p-4">
  <div class="flex items-center gap-3 mb-4">
    <i class="pi pi-shield-check text-2xl"></i>
    <h2 class="text-xl font-semibold">Quality Control Check</h2>
  </div>

  <!-- Order Information -->
  <div class="mb-4 p-3 bg-surface-50 dark:bg-surface-800 rounded-lg">
    <h3 class="font-medium mb-2">Order Details</h3>
    <div class="flex flex-col gap-2">
      <div class="flex items-center gap-2">
        <i class="pi pi-receipt"></i>
        <span>Order #{{ data.order.orderNumber }}</span>
      </div>
      @if (data.order.customerName) {
        <div class="flex items-center gap-2">
          <i class="pi pi-user"></i>
          <span>{{ data.order.customerName }}</span>
        </div>
      }
      @if (selectedItem()) {
        <div class="flex items-center gap-2">
          <i class="pi pi-list"></i>
          <span>{{ selectedItem()!.product.name }}</span>
        </div>
      }
    </div>
  </div>

  <p-divider></p-divider>

  <!-- Quality Check Form -->
  <form [formGroup]="qualityForm" class="flex flex-col gap-4">
    <!-- Overall Quality Rating -->
    <div>
      <h3 class="font-medium mb-3">Overall Quality Rating</h3>
      <div class="flex flex-col gap-2">
        @for (rating of qualityRatings; track rating) {
          <label class="flex items-center gap-3 p-3 rounded-lg border border-surface-200 dark:border-surface-700 cursor-pointer hover:bg-surface-50 dark:hover:bg-surface-800">
            <p-radiobutton
              [value]="rating.value"
              formControlName="overallRating"
              [inputId]="'rating-' + rating.value">
            </p-radiobutton>
            <div class="flex items-center gap-3 flex-1">
              <i [class]="'pi ' + (rating.icon === 'star' ? 'pi-star-fill' : rating.icon === 'thumb_up' ? 'pi-thumbs-up' : rating.icon === 'remove' ? 'pi-minus' : rating.icon === 'thumb_down' ? 'pi-thumbs-down' : 'pi-exclamation-circle') + ' text-xl'"></i>
              <div>
                <div class="font-medium">{{ rating.label }}</div>
                <div class="text-sm text-surface-600 dark:text-surface-400">{{ rating.description }}</div>
              </div>
            </div>
          </label>
        }
      </div>
    </div>

    <p-divider></p-divider>

    <!-- Quality Checklist -->
    <div>
      <h3 class="font-medium mb-3">Quality Checklist</h3>
      <div formArrayName="checklistItems" class="flex flex-col gap-3">
        @for (item of checklistItemsArray.controls; track item; let i = $index) {
          <div [formGroupName]="i" class="p-3 rounded-lg border border-surface-200 dark:border-surface-700">
            <div class="flex items-start gap-2 mb-2">
              <p-checkbox
                formControlName="passed"
                [binary]="true"
                [inputId]="'check-' + i">
              </p-checkbox>
              <label [for]="'check-' + i" class="flex-1 cursor-pointer">
                {{ getChecklistItem(i).name }}
                @if (getChecklistItem(i).required) {
                  <i class="pi pi-star-fill text-yellow-500 ml-1 text-xs"></i>
                }
              </label>
            </div>
            <div class="text-sm text-surface-600 dark:text-surface-400 ml-7 mb-2">
              {{ getChecklistItem(i).description }}
            </div>
            @if (!item.get('passed')?.value && getChecklistItem(i).required) {
              <div class="ml-7">
                <p-floatlabel>
                  <textarea
                    pInputTextarea
                    formControlName="notes"
                    rows="2"
                    class="w-full"
                    [id]="'notes-' + i">
                  </textarea>
                  <label [for]="'notes-' + i">Reason for failure (required)</label>
                </p-floatlabel>
              </div>
            }
            @if (item.get('passed')?.value) {
              <div class="ml-7">
                <p-floatlabel>
                  <textarea
                    pInputTextarea
                    formControlName="notes"
                    rows="2"
                    class="w-full"
                    [id]="'notes-opt-' + i">
                  </textarea>
                  <label [for]="'notes-opt-' + i">Additional notes (optional)</label>
                </p-floatlabel>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <p-divider></p-divider>

    <!-- Inspector Comments -->
    <div>
      <h3 class="font-medium mb-3">Inspector Comments</h3>
      <p-floatlabel>
        <textarea
          pInputTextarea
          formControlName="comments"
          rows="3"
          class="w-full"
          id="comments">
        </textarea>
        <label for="comments">Additional Comments</label>
      </p-floatlabel>
    </div>

    <!-- Quality Score Display -->
    <div class="p-4 bg-surface-50 dark:bg-surface-800 rounded-lg">
      <h3 class="font-medium mb-3">Quality Score</h3>
      <div class="flex items-center gap-4">
        <div class="flex flex-col items-center justify-center w-24 h-24 rounded-full bg-surface-100 dark:bg-surface-900">
          <div class="text-3xl font-bold">{{ calculateQualityScore() }}</div>
          <div class="text-sm text-surface-600 dark:text-surface-400">/ 100</div>
        </div>
        <div class="flex-1">
          <div class="flex justify-between mb-1 text-sm">
            <span>Checklist Score:</span>
            <span>{{ getChecklistScore() }}%</span>
          </div>
          <div class="flex justify-between mb-3 text-sm">
            <span>Overall Rating:</span>
            <span>{{ getOverallRatingScore() }}%</span>
          </div>
          <div class="font-medium" [class]="'text-' + getScoreClass()">
            {{ getScoreStatus() }}
          </div>
        </div>
      </div>
    </div>

    <!-- Action Recommendation -->
    <div class="flex items-start gap-3 p-3 rounded-lg" [class]="'bg-' + getRecommendationClass() + '-50 dark:bg-' + getRecommendationClass() + '-900/20'">
      <i [class]="'pi ' + (getRecommendationIcon() === 'check_circle' ? 'pi-check-circle' : getRecommendationIcon() === 'warning' ? 'pi-exclamation-triangle' : 'pi-times-circle') + ' text-xl'"></i>
      <div>
        <div class="font-medium mb-1">{{ getRecommendationTitle() }}</div>
        <div class="text-sm text-surface-600 dark:text-surface-400">{{ getRecommendationDescription() }}</div>
      </div>
    </div>
  </form>

  <!-- Dialog Actions -->
  <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-surface-200 dark:border-surface-700">
    <p-button
      label="Cancel"
      severity="secondary"
      (click)="onCancel()">
    </p-button>
    @if (shouldShowRejectButton()) {
      <p-button
        label="Reject Order"
        severity="danger"
        icon="pi pi-times"
        (click)="onReject()"
        [disabled]="!canReject()">
      </p-button>
    }
    <p-button
      [label]="getApprovalButtonText()"
      [icon]="'pi ' + (getApprovalIcon() === 'check_circle' ? 'pi-check' : getApprovalIcon() === 'warning' ? 'pi-exclamation-triangle' : 'pi-times')"
      (click)="onApprove()"
      [disabled]="!canApprove()">
    </p-button>
  </div>
</div>
