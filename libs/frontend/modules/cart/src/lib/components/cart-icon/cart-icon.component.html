<!-- Cart Icon Button -->
<p-button
  #cartButton
  [icon]="cartIcon()"
  [badge]="itemCount() > 0 ? itemCount().toString() : undefined"
  badgeClass="cart-badge"
  [severity]="buttonSeverity()"
  [outlined]="outlined()"
  [text]="text()"
  [size]="size()"
  [disabled]="disabled()"
  [pTooltip]="tooltipText()"
  tooltipPosition="bottom"
  (onClick)="onCartClick($event)"
  [style]="buttonStyles()"
  [class]="'cart-icon-button transition-all duration-300 hover:scale-105 ' + (additionalClasses() || '')">
</p-button>

<!-- Cart Preview Overlay -->
<p-popover
  #cartOverlay
  [style]="{ width: '400px', maxHeight: '600px' }"
  [appendTo]="'body'"
  [dismissable]="true">

  <ng-template pTemplate="content">
    <div class="p-0 max-h-[550px] overflow-hidden">
      <!-- Header -->
      <div class="p-4 pt-4 pb-0 border-b border-surface-border bg-surface-ground -m-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="m-0">Your Cart</h4>
          <div>
            <span class="text-sm text-color-secondary">
              {{ itemCount() }} {{ itemCount() === 1 ? 'item' : 'items' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Empty Cart State -->
      @if (isEmpty()) {
        <div class="p-4 text-center">
          <div class="py-4">
            <i class="pi pi-shopping-cart text-4xl text-color-secondary mb-3"></i>
            <p class="text-lg font-medium mb-2 text-color">Your cart is empty</p>
            <p class="text-sm text-color-secondary mb-3">Add some delicious items to get started!</p>
            <p-button
              label="Browse Menu"
              icon="pi pi-search"
              [outlined]="true"
              (onClick)="navigateToMenu(); hideOverlay()">
            </p-button>
          </div>
        </div>
      }

      <!-- Cart Items Preview -->
      @if (!isEmpty()) {
        <div class="px-4 pb-4">
          <!-- Items List -->
          <div class="bg-surface-card rounded-md">
            <p-scrollPanel [style]="{ width: '100%', height: '300px' }">
              <div class="p-2">
                @for (item of items().slice(0, maxPreviewItems()); track trackByItemId($index, item)) {
                  <div class="mb-3 p-3 rounded-md border border-surface-border bg-surface-card transition-all duration-200 hover:border-primary hover:-translate-y-0.5 hover:shadow-md animate-slide-in">
                    <div class="flex items-start gap-3">
                      <!-- Item Image -->
                      <div class="w-[50px] h-[50px] rounded flex-shrink-0 overflow-hidden bg-surface-ground">
                        @if (item.imageUrl) {
                          <img [src]="item.imageUrl" [alt]="item.name" class="w-full h-full object-cover">
                        } @else {
                          <div class="w-full h-full flex items-center justify-center bg-surface-ground">
                            <i class="pi pi-image text-xl text-color-secondary"></i>
                          </div>
                        }
                      </div>
                      <!-- Item Details -->
                      <div class="flex-1 min-w-0">
                        <h6 class="text-sm font-semibold m-0 mb-1 text-color truncate">{{ item.name }}</h6>
                        <div class="flex items-center justify-between">
                          <span class="text-sm text-color-secondary">Qty: {{ item.quantity }}</span>
                          <span class="font-medium text-color">{{ item.totalPrice | currency }}</span>
                        </div>
                        <!-- Customizations Summary -->
                        @if (hasCustomizations(item)) {
                          <div class="mt-1">
                            <span class="text-xs text-color-secondary truncate block">
                              {{ getCustomizationsSummary(item) }}
                            </span>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }
                <!-- Show More Items Indicator -->
                @if (items().length > maxPreviewItems()) {
                  <div class="text-center p-2">
                    <p-divider styleClass="my-2"></p-divider>
                    <span class="text-sm text-color-secondary">
                      +{{ items().length - maxPreviewItems() }}
                      more {{ items().length - maxPreviewItems() === 1 ? 'item' : 'items' }}
                    </span>
                  </div>
                }
              </div>
            </p-scrollPanel>
          </div>
          <p-divider styleClass="my-3"></p-divider>
          <!-- Cart Summary -->
          <div class="bg-surface-ground p-4 rounded-md border border-surface-border">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-color">Subtotal:</span>
              <span class="text-sm font-medium text-color">{{ subtotal() | currency }}</span>
            </div>
            <div class="flex items-center justify-between mb-3">
              <span class="font-medium text-color">Total:</span>
              <span class="font-bold text-primary text-lg">{{ total() | currency }}</span>
            </div>
            <!-- Action Buttons -->
            <div class="flex gap-2 mt-4">
              <p-button
                label="View Cart"
                [outlined]="true"
                styleClass="flex-1"
                (onClick)="navigateToCart(); hideOverlay()">
              </p-button>
              <p-button
                label="Checkout"
                [disabled]="!isValidForCheckout()"
                styleClass="flex-1"
                (onClick)="navigateToCheckout(); hideOverlay()">
              </p-button>
            </div>
            <!-- Validation Messages -->
            @if (!isValidForCheckout()) {
              <div class="mt-2 bg-red-50 p-2 rounded border border-red-200">
                @for (error of errors().slice(0, 2); track error) {
                  <div class="text-xs text-red-500 mb-1">
                    <i class="pi pi-exclamation-triangle mr-1"></i>
                    {{ formatError(error) }}
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </ng-template>
</p-popover>
